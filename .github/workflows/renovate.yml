name: Renovate PR Checker

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  renovate-check:
    name: renovate-check
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'renovate[bot]'

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect changed files
        id: files
        shell: bash
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          FILES=$(git diff "$BASE"...HEAD --name-only || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Skip if no relevant changes
        if: |
          !contains(steps.files.outputs.files, 'build.sh') &&
          !contains(steps.files.outputs.files, 'package.json') &&
          !contains(steps.files.outputs.files, 'Cargo.toml') &&
          !contains(steps.files.outputs.files, 'requirements.txt')
        run: |
          echo "‚ÑπÔ∏è No relevant files changed by Renovate"
          exit 0

      - name: Lint build.sh (syntax)
        if: contains(steps.files.outputs.files, 'build.sh')
        shell: bash
        run: |
          set -e
          for file in $(echo "${{ steps.files.outputs.files }}" | grep build.sh); do
            echo "üßπ Checking $file"
            sed -i 's/\r$//' "$file"
            bash -n "$file"
          done

      - name: Validate package metadata
        shell: bash
        run: |
          FAIL=0
          BASE="${{ github.event.pull_request.base.sha }}"

          PKGS=$(git diff "$BASE"...HEAD --name-only \
            | awk -F/ '/^packages\/[^/]+\/build.sh$/ {print $2}' \
            | sort -u)

          for PKG in $PKGS; do
            BUILD="packages/$PKG/build.sh"
            echo "üì¶ $PKG"

            get() { grep -E "^$1=" "$BUILD" | cut -d= -f2- | head -n1; }

            VERSION=$(get TERMUX_PKG_VERSION)
            SRCURL=$(get TERMUX_PKG_SRCURL)
            SHA256=$(get TERMUX_PKG_SHA256)

            [[ -z "$VERSION" || -z "$SRCURL" || -z "$SHA256" ]] && FAIL=1
            [[ "$SHA256" =~ ^[a-f0-9]{64}$ ]] || FAIL=1
          done

          [ "$FAIL" -eq 0 ]

      - name: Comment success
        if: success()
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ü§ñ **Renovate PR detected**
            ‚úÖ Checks passed
            üîí Manual review still required
