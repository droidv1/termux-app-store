name: PR Package Checker & Report

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
      - labeled

permissions:
  contents: read
  pull-requests: write

jobs:
  review-packages:
    name: Validate changed packages
    runs-on: ubuntu-latest

    if: |
      contains(
        join(github.event.pull_request.labels.*.name, ','),
        'review-approved'
      )

    steps:
      - name: Checkout PR code (safe)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect changed packages
        id: packages
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          PKGS=$(git diff "$BASE_SHA"...HEAD --name-only \
            | awk -F/ '/^packages\/[^/]+\/build.sh$/ {print $2}' \
            | sort -u)

          echo "changed=$PKGS" >> "$GITHUB_OUTPUT"

      - name: Validate build.sh metadata (safe expand)
        id: checker
        shell: bash
        run: |
          set -e
          FAIL=0
          REPORT=""

          if [[ -z "${{ steps.packages.outputs.changed }}" ]]; then
            REPORT+="‚ÑπÔ∏è No package changes detected\n"
          fi

          for PKG in ${{ steps.packages.outputs.changed }}; do
            BUILD_SH="packages/$PKG/build.sh"
            REPORT+="## üì¶ $PKG\n"

            if [[ ! -f "$BUILD_SH" ]]; then
              REPORT+="- ‚ùå build.sh missing\n\n"
              FAIL=1
              continue
            fi

            get_var() {
              grep -E "^$1=" "$BUILD_SH" | head -n1 | cut -d= -f2-
            }

            VERSION=$(get_var TERMUX_PKG_VERSION)
            SRCURL_RAW=$(get_var TERMUX_PKG_SRCURL)
            SHA256=$(get_var TERMUX_PKG_SHA256)

            check() {
              if [[ -z "$2" ]]; then
                REPORT+="- ‚ùå Missing \`$1\`\n"
                FAIL=1
              else
                REPORT+="- ‚úî \`$1\`\n"
              fi
            }

            check TERMUX_PKG_VERSION "$VERSION"
            check TERMUX_PKG_SRCURL "$SRCURL_RAW"
            check TERMUX_PKG_SHA256 "$SHA256"

            # --- SAFE EXPANSION (NO eval / NO source) ---
            SRCURL="$SRCURL_RAW"
            if [[ "$SRCURL" == *'${TERMUX_PKG_VERSION}'* ]]; then
              if [[ -z "$VERSION" ]]; then
                REPORT+="- ‚ùå TERMUX_PKG_VERSION required for SRCURL expansion\n"
                FAIL=1
              else
                SRCURL="${SRCURL//\$\{TERMUX_PKG_VERSION\}/$VERSION}"
                REPORT+="- üîÅ SRCURL expanded using TERMUX_PKG_VERSION\n"
              fi
            fi

            if [[ -n "$SHA256" && ! "$SHA256" =~ ^[a-f0-9]{64}$ ]]; then
              REPORT+="- ‚ùå Invalid SHA256 format\n"
              FAIL=1
            fi

            if [[ "$SRCURL" =~ (latest|master|main) ]]; then
              REPORT+="- ‚ùå Floating SRCURL detected\n"
              FAIL=1
            fi

            if [[ -n "$SRCURL" && -n "$SHA256" ]]; then
              TMP="$(mktemp)"
              if curl -fsL "$SRCURL" -o "$TMP"; then
                CALC=$(sha256sum "$TMP" | awk '{print $1}')
                if [[ "$CALC" != "$SHA256" ]]; then
                  REPORT+="- ‚ùå SHA256 mismatch\n"
                  REPORT+="  Expected: $SHA256\n"
                  REPORT+="  Got     : $CALC\n"
                  FAIL=1
                else
                  REPORT+="- ‚úÖ SHA256 verified\n"
                fi
              else
                REPORT+="- ‚ùå Failed to download source\n"
                FAIL=1
              fi
              rm -f "$TMP"
            fi

            REPORT+="\n"
          done

          echo "report<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$REPORT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "fail=$FAIL" >> "$GITHUB_OUTPUT"

      - name: Post PR report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: ${{ steps.checker.outputs.report }}

      - name: Fail PR if validation failed
        if: steps.checker.outputs.fail != '0'
        run: |
          echo "‚ùå Package validation failed"
          exit 1
