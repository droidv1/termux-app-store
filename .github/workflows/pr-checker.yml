name: PR Package Checker & Reported

on:
  workflow_run:
    workflows: ["Lint PR Checker & Helper"]
    types:
      - completed

jobs:
  review-packages:
    if: contains(github.event.workflow_run.pull_requests[0].labels.*.name, 'review-approved')
    runs-on: ubuntu-latest
    name: PR Package Build & Check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bash curl git ca-certificates \
            python3 python3-pip \
            nodejs npm \
            rustc cargo \
            dpkg unzip xz-utils

      - name: Detect changed packages
        id: packages
        shell: bash
        run: |
          PKGS=$(git diff origin/master...HEAD --name-only \
            | awk -F/ '/^packages\//{print $2}' \
            | sort -u)
          echo "changed=${PKGS:-}" >> "$GITHUB_OUTPUT"

      - name: PR package build & run check
        id: checker
        shell: bash
        run: |
          set -Eeuo pipefail
          FAIL=0
          REPORT=""
          if [[ -z "${{ steps.packages.outputs.changed }}" ]]; then
            REPORT+="‚ÑπÔ∏è No package changes detected"$'\n'
          fi
          for PKG in ${{ steps.packages.outputs.changed }}; do
            echo "=== Checking package: $PKG ==="
            BUILD_SH="packages/$PKG/build.sh"
            REPORT+="## üì¶ $PKG"$'\n'
            if [[ ! -f "$BUILD_SH" ]]; then
              REPORT+="- ‚ùå build.sh missing"$'\n\n'
              FAIL=1
              continue
            fi
            source "$BUILD_SH" || true
            check() {
              if [[ -z "${!1:-}" ]]; then
                REPORT+="- ‚ùå Missing \`$1\`"$'\n'
                FAIL=1
              else
                REPORT+="- ‚úî \`$1\`"$'\n'
              fi
            }
            check TERMUX_PKG_VERSION
            check TERMUX_PKG_SRCURL
            check TERMUX_PKG_SHA256
            if [[ ! "${TERMUX_PKG_SHA256:-}" =~ ^[a-f0-9]{64}$ ]]; then
              REPORT+="- ‚ùå Invalid SHA256 format"$'\n'
              FAIL=1
            fi
            if [[ "${TERMUX_PKG_SRCURL:-}" =~ (latest|master|main) ]]; then
              REPORT+="- ‚ùå Floating SRCURL (latest/master/main)"$'\n'
              FAIL=1
            fi
            REPORT+=$'\n'
            SRCURL=$(eval echo "${TERMUX_PKG_SRCURL:-}")
            TMPFILE="$(mktemp)"
            if ! curl -fsL "$SRCURL" -o "$TMPFILE"; then
              REPORT+="‚ùå Failed to download source"$'\n\n'
              FAIL=1
              rm -f "$TMPFILE"
              continue
            fi
            ACTUAL_SHA=$(sha256sum "$TMPFILE" | awk '{print $1}')
            if [[ "$ACTUAL_SHA" != "$TERMUX_PKG_SHA256" ]]; then
              REPORT+="‚ùå SHA256 mismatch"$'\n'
              REPORT+="  Expected: $TERMUX_PKG_SHA256"$'\n'
              REPORT+="  Got     : $ACTUAL_SHA"$'\n'
              REPORT+="üí° Suggestion: Recalculate sha256sum after updating version"$'\n\n'
              FAIL=1
              rm -f "$TMPFILE"
              continue
            else
              REPORT+="‚úÖ SHA256 verified"$'\n'
            fi
            rm -f "$TMPFILE"
            if ! ./build-package.sh "$PKG"; then
              REPORT+="‚ùå Build failed"$'\n'
              REPORT+="üí° Suggestion: Check build dependencies or install step"$'\n\n'
              FAIL=1
              continue
            fi
            BIN_CANDIDATES="${TERMUX_PKG_BIN_NAME:-$PKG}"
            FOUND_BIN=""
            for bin in $BIN_CANDIDATES; do
              if [[ -f ".local-prefix/bin/$bin" ]]; then
                FOUND_BIN=".local-prefix/bin/$bin"
                break
              fi
            done
            if [[ -z "$FOUND_BIN" ]]; then
              REPORT+="- ‚ùå Binary not found in .local-prefix/bin"$'\n\n'
              FAIL=1
              continue
            fi
            EXT="${FOUND_BIN##*.}"
            case "$EXT" in
              sh) RUN_CMD="bash $FOUND_BIN" ;;
              py) RUN_CMD="python3 $FOUND_BIN" ;;
              js) RUN_CMD="node $FOUND_BIN" ;;
              *)  RUN_CMD="$FOUND_BIN" ;;
            esac
            if $RUN_CMD --help >/dev/null 2>&1 || $RUN_CMD >/dev/null 2>&1; then
              REPORT+="- ‚úÖ Tool ran successfully (\`$FOUND_BIN\`)"$'\n\n'
            else
              REPORT+="- ‚ùå Tool failed to run (\`$FOUND_BIN\`)"$'\n'
              REPORT+="- üí° Suggestion:"$'\n'
              REPORT+="  - Check shebang & permissions"$'\n'
              REPORT+="  - Ensure runtime dependencies exist"$'\n\n'
              FAIL=1
            fi
          done
          echo "report<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$REPORT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "fail=$FAIL" >> "$GITHUB_OUTPUT"

      - name: Post PR report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: ${{ steps.checker.outputs.report }}

      - name: Mark PR failed if needed
        if: ${{ steps.checker.outputs.fail != '0' }}
        run: |
          echo "‚ùå One or more packages failed checks"
          exit 1
