name: Lint PR Checker & Auto-Label

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
    paths:
      - 'packages/*/build.sh'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  lint:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    name: Lint and validate build.sh files

    steps:
      - name: Debug - Show PR info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR State: ${{ github.event.pull_request.state }}"
          echo "PR Merged: ${{ github.event.pull_request.merged }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"
          echo "Merge Commit SHA: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "Head Ref: ${{ github.event.pull_request.head.ref }}"
          echo "Base Ref: ${{ github.event.pull_request.base.ref }}"

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # If PR is merged, checkout the merge commit
          # If PR is open, checkout the head
          ref: ${{ github.event.pull_request.merged && github.event.pull_request.merge_commit_sha || github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Find changed build.sh files
        id: files
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Comparing: $BASE_SHA...$HEAD_SHA"
          
          # Get changed files
          FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep 'packages/.*/build.sh' || true)

          {
            echo "changed_files<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Changed files:"
          echo "$FILES"
          echo ""
          
          # Verify files exist
          if [ -n "$FILES" ]; then
            echo "Verifying file existence:"
            while read -r file; do
              [ -z "$file" ] && continue
              if [ -f "$file" ]; then
                echo "  ‚úÖ $file exists"
              else
                echo "  ‚ùå $file NOT FOUND"
              fi
            done <<< "$FILES"
          fi

      - name: Lint build.sh (bash syntax check)
        id: lint
        shell: bash
        run: |
          ERROR=0
          LINT_DETAILS=""

          while read -r file; do
            [ -z "$file" ] && continue
            
            echo "üßπ Checking syntax: $file"
            
            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "‚ùå File not found: $file"
              ERROR=1
              LINT_DETAILS="${LINT_DETAILS}### ‚ùå File Not Found: \`$file\`\n\n"
              LINT_DETAILS="${LINT_DETAILS}This file appears in git diff but doesn't exist in the working directory.\n"
              LINT_DETAILS="${LINT_DETAILS}This may indicate the file was deleted or the checkout failed.\n\n"
              continue
            fi
            
            # Normalize line endings
            sed -i 's/\r$//' "$file"
            
            # Check bash syntax
            if ! bash -n "$file" 2>&1 | tee /tmp/lint_error.txt; then
              echo "‚ùå Syntax error in $file"
              ERROR=1
              LINT_DETAILS="${LINT_DETAILS}### ‚ùå Syntax Error: \`$file\`\n\n"
              LINT_DETAILS="${LINT_DETAILS}\`\`\`\n$(cat /tmp/lint_error.txt)\n\`\`\`\n\n"
            else
              echo "‚úÖ Syntax OK: $file"
            fi
          done <<< "${{ steps.files.outputs.changed_files }}"

          {
            echo "lint_status=$ERROR"
            echo "lint_details<<EOF"
            echo -e "$LINT_DETAILS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Validate TERMUX_PKG_* variables
        id: validate
        shell: bash
        run: |
          set +e  # Don't exit on error - we'll handle errors manually
          VALIDATION_ERROR=0
          VALIDATION_DETAILS=""
          CURL_TIMEOUT=30

          while read -r file; do
            [ -z "$file" ] && continue

            echo "üîç Validating content: $file"
            
            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "‚ùå File not found: $file (skipping validation)"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}## üì¶ File: \`$file\`\n\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **File not found in working directory**\n\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}---\n\n"
              continue
            fi
            
            # Extract package name safely
            PKG_DIR=$(dirname "$file" 2>/dev/null || echo "unknown")
            PKG_NAME=$(basename "$PKG_DIR" 2>/dev/null || echo "unknown")

            # Extract variables safely with error handling
            get_var() {
              local var_name="$1"
              local result
              result=$(grep -E "^${var_name}=" "$file" 2>/dev/null | head -1 | sed 's/^[^=]*=//' | sed "s/^['\"]//;s/['\"]$//" | tr -d "'" 2>/dev/null || echo "")
              echo "$result"
            }

            SRCURL=$(get_var TERMUX_PKG_SRCURL)
            VERSION=$(get_var TERMUX_PKG_VERSION)
            SHA256=$(get_var TERMUX_PKG_SHA256)
            HOMEPAGE=$(get_var TERMUX_PKG_HOMEPAGE)
            DESCRIPTION=$(get_var TERMUX_PKG_DESCRIPTION)
            MAINTAINER=$(get_var TERMUX_PKG_MAINTAINER)
            LICENSE=$(get_var TERMUX_PKG_LICENSE)

            echo "   Package: $PKG_NAME"
            echo "   SRCURL: ${SRCURL:0:50}..."
            echo "   VERSION: $VERSION"
            echo "   SHA256: ${SHA256:0:20}..."

            VALIDATION_DETAILS="${VALIDATION_DETAILS}## üì¶ Package: \`$PKG_NAME\`\n\n"

            # Required field validations (ONLY VERSION, SRCURL, SHA256)
            # Note: TERMUX_PKG_NAME is NOT required - package name from folder
            MISSING_REQUIRED=false

            if [ -z "$VERSION" ]; then
              echo "‚ùå TERMUX_PKG_VERSION not defined"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **TERMUX_PKG_VERSION** is required\n"
              MISSING_REQUIRED=true
            fi

            if [ -z "$SRCURL" ]; then
              echo "‚ùå TERMUX_PKG_SRCURL not defined"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **TERMUX_PKG_SRCURL** is required\n"
              MISSING_REQUIRED=true
            fi

            if [ -z "$SHA256" ]; then
              echo "‚ùå TERMUX_PKG_SHA256 not defined"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **TERMUX_PKG_SHA256** is required\n"
              MISSING_REQUIRED=true
            fi

            # Skip further checks if required fields are missing
            if [ "$MISSING_REQUIRED" = true ]; then
              VALIDATION_DETAILS="${VALIDATION_DETAILS}\n---\n\n"
              continue
            fi

            # SHA256 format validation
            if ! [[ "$SHA256" =~ ^[a-fA-F0-9]{64}$ ]]; then
              echo "‚ùå Invalid SHA256 format"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **TERMUX_PKG_SHA256** format invalid (must be 64 hex chars)\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  Got: \`$SHA256\`\n"
            fi

            # URL format validation
            if ! [[ "$SRCURL" =~ ^https?:// ]]; then
              echo "‚ùå Invalid SRCURL format"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **TERMUX_PKG_SRCURL** must be a valid HTTP(S) URL\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  Got: \`$SRCURL\`\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}\n---\n\n"
              continue
            fi

            # Expand ${TERMUX_PKG_VERSION} in SRCURL
            DOWNLOAD_URL="$SRCURL"
            DOWNLOAD_URL="${DOWNLOAD_URL//\$\{TERMUX_PKG_VERSION\}/$VERSION}"
            DOWNLOAD_URL="${DOWNLOAD_URL//\$TERMUX_PKG_VERSION/$VERSION}"

            # Check for malformed syntax
            if [[ "$DOWNLOAD_URL" =~ \}\} ]] || [[ "$DOWNLOAD_URL" =~ \}\$ ]] || [[ "$DOWNLOAD_URL" =~ [^{]\}[^}] ]]; then
              echo "‚ùå Malformed SRCURL syntax"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **SRCURL contains invalid syntax**\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  Original: \`$SRCURL\`\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  Processed: \`$DOWNLOAD_URL\`\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}\n---\n\n"
              continue
            fi

            echo "   Final URL: ${DOWNLOAD_URL:0:70}..."

            # Download and verify SHA256
            if timeout $CURL_TIMEOUT curl -fsSL -o /tmp/source_file "$DOWNLOAD_URL" 2>/dev/null; then
              COMPUTED_SHA256=$(sha256sum /tmp/source_file 2>/dev/null | awk '{print $1}')
              FILE_SIZE=$(ls -lh /tmp/source_file 2>/dev/null | awk '{print $5}')

              echo "   Downloaded: $FILE_SIZE"
              echo "   Computed SHA256: $COMPUTED_SHA256"

              if [ "$COMPUTED_SHA256" = "$SHA256" ]; then
                echo "‚úÖ SHA256 verified"
                VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚úÖ **SHA256 verified** (downloaded $FILE_SIZE)\n"
              else
                echo "‚ùå SHA256 MISMATCH"
                VALIDATION_ERROR=1
                VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **SHA256 MISMATCH**\n"
                VALIDATION_DETAILS="${VALIDATION_DETAILS}  - Expected: \`$SHA256\`\n"
                VALIDATION_DETAILS="${VALIDATION_DETAILS}  - Got: \`$COMPUTED_SHA256\`\n"
              fi
              rm -f /tmp/source_file 2>/dev/null || true
            else
              HTTP_CODE=$(curl -fsSL -o /dev/null -w "%{http_code}" "$DOWNLOAD_URL" 2>/dev/null || echo "000")
              echo "‚ùå Download failed (HTTP: $HTTP_CODE)"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ùå **Failed to download source**\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  - URL: \`$DOWNLOAD_URL\`\n"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}  - HTTP Status: \`$HTTP_CODE\`\n"
            fi

            # Optional field warnings
            [ -z "$LICENSE" ] && VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ö†Ô∏è  TERMUX_PKG_LICENSE not defined (recommended)\n"
            [ -z "$HOMEPAGE" ] && VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ö†Ô∏è  TERMUX_PKG_HOMEPAGE not defined (recommended)\n"
            [ -z "$DESCRIPTION" ] && VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ö†Ô∏è  TERMUX_PKG_DESCRIPTION not defined (recommended)\n"
            [ -z "$MAINTAINER" ] && VALIDATION_DETAILS="${VALIDATION_DETAILS}- ‚ö†Ô∏è  TERMUX_PKG_MAINTAINER not defined (recommended)\n"

            VALIDATION_DETAILS="${VALIDATION_DETAILS}\n---\n\n"

          done <<< "${{ steps.files.outputs.changed_files }}"

          # Final status output
          {
            echo "validation_status=$VALIDATION_ERROR"
            echo "validation_details<<EOF"
            echo -e "$VALIDATION_DETAILS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          
          echo ""
          echo "Validation completed with status: $VALIDATION_ERROR"

      - name: Determine overall status
        id: status
        shell: bash
        run: |
          LINT_STATUS="${{ steps.lint.outputs.lint_status }}"
          VALIDATION_STATUS="${{ steps.validate.outputs.validation_status }}"

          if [ "$LINT_STATUS" = "1" ] || [ "$VALIDATION_STATUS" = "1" ]; then
            OVERALL_STATUS=1
          else
            OVERALL_STATUS=0
          fi

          echo "overall_status=$OVERALL_STATUS" >> "$GITHUB_OUTPUT"
          echo "Overall status: $OVERALL_STATUS (0=pass, 1=fail)"

      - name: Remove old labels
        continue-on-error: true
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-approved, review-failed

      - name: Add review-approved label (auto-triggers pr-checker.yml)
        if: steps.status.outputs.overall_status == '0'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-approved

      - name: Add review-failed label
        if: steps.status.outputs.overall_status == '1'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-failed

      - name: Comment - Validation Failed
        if: steps.status.outputs.overall_status == '1'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lint-validation
          message: |
            # ‚ùå Build Script Validation Failed

            Your `build.sh` file(s) failed automated validation checks.

            ${{ steps.lint.outputs.lint_details }}

            ${{ steps.validate.outputs.validation_details }}

            ## üîß How to Fix

            1. **Check syntax errors** - Ensure all bash syntax is valid
            2. **Verify SRCURL** - Ensure the URL is correct and accessible
               - Check for typos in the URL
               - Verify `${TERMUX_PKG_VERSION}` is properly closed
               - Test the URL manually in your browser
            3. **Update SHA256** - Download the file and compute the correct hash:
               ```bash
               curl -L "YOUR_SRCURL" -o file.tar.gz
               sha256sum file.tar.gz
               ```
            4. **Add required fields**:
               - `TERMUX_PKG_VERSION` (required)
               - `TERMUX_PKG_SRCURL` (required)
               - `TERMUX_PKG_SHA256` (required)
               - `TERMUX_PKG_LICENSE` (recommended)
               - `TERMUX_PKG_HOMEPAGE` (recommended)

            ## Example Valid build.sh

            ```bash
            TERMUX_PKG_NAME="mypackage"
            TERMUX_PKG_VERSION="1.0.0"
            TERMUX_PKG_SRCURL=https://github.com/user/repo/archive/refs/tags/v${TERMUX_PKG_VERSION}.tar.gz
            TERMUX_PKG_SHA256="abc123...def456"  # 64 hex characters
            TERMUX_PKG_LICENSE="MIT"
            TERMUX_PKG_HOMEPAGE="https://github.com/user/repo"
            TERMUX_PKG_DESCRIPTION="A useful tool"
            TERMUX_PKG_MAINTAINER="Your Name <email@example.com>"
            ```

            Push new commits to automatically re-run validation.

      - name: Comment - Validation Passed
        if: steps.status.outputs.overall_status == '0'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lint-validation
          message: |
            # ‚úÖ Build Script Validation Passed

            Your `build.sh` file(s) have passed all automated checks:

            - ‚úÖ Bash syntax is correct
            - ‚úÖ All required TERMUX_PKG_* variables are defined
            - ‚úÖ SRCURL is valid and reachable
            - ‚úÖ SHA256 checksum verified successfully

            **Label `review-approved` has been added automatically.**

            This will trigger the package review workflow for detailed inspection.
            
            Thank you for your contribution! üéâ

      - name: Fail workflow if validation failed
        if: steps.status.outputs.overall_status == '1'
        run: |
          echo "‚ùå Validation failed - please check PR comments for details"
          exit 1
