name: Auto Update Packages Changelog

on:
  push:
    branches:
      - master
    paths:
      - 'packages/**/build.sh'

permissions:
  contents: write

jobs:
  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect package changes and update changelog
        shell: bash
        run: |
          set -e

          CHANGELOG="CHANGELOG.md"

          if [[ ! -f "$CHANGELOG" ]]; then
            printf "%s\n" \
              "# Changelog" \
              "" \
              "## [Unreleased]" \
              "### Added" \
              "" \
              "### Updated" \
              "" \
              "### Fixed" \
              "" \
              > "$CHANGELOG"
            echo "[✓] Created CHANGELOG.md"
          fi

          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^packages/.*/build\.sh' || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "[ℹ] No package changes detected"
            exit 0
          fi

          echo "[✓] Changed packages:"
          echo "$CHANGED_FILES"

          for build_file in $CHANGED_FILES; do
            pkg_dir=$(dirname "$build_file")
            pkg_name=$(basename "$pkg_dir")

            pkg_version=$(grep '^TERMUX_PKG_VERSION=' "$build_file" | cut -d= -f2)

            if [[ -z "$pkg_version" ]]; then
              continue
            fi

            if ! grep -q "\`${pkg_name}\` v${pkg_version}" "$CHANGELOG"; then
              sed -i "/### Updated/a - Package \`${pkg_name}\` v${pkg_version}" "$CHANGELOG"
              echo "[✓] Updated: ${pkg_name} v${pkg_version}"
            fi
          done

      - name: Commit & push changelog
        run: |
          git config user.name "Termux App Store Bot"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "[ℹ] Nothing to commit"
            exit 0
          fi

          git add CHANGELOG.md
          git commit -m "Update/Added packages: update changelog [ci skip]" || true
          git push origin master
