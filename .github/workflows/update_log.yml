name: Auto Update Packages Changelog

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Scan packages and prepare changelog entries
        run: |
          set -euo pipefail

          CHANGELOG="CHANGELOG.md"
          PACKAGES_DIR="packages"

          [[ -f "$CHANGELOG" ]] || echo -e "# Changelog\n\n## [Unreleased]\n" > "$CHANGELOG"

          ADDED=""
          CHANGED=""
          FIXED=""

          echo "Scanning packages for updates..."

          for pkg in "$PACKAGES_DIR"/*; do
            [[ -d "$pkg" ]] || continue
            BUILD_FILE="$pkg/build.sh"
            [[ -f "$BUILD_FILE" ]] || continue

            PKG_NAME=$(basename "$pkg")
            PKG_VERSION=$(grep "^TERMUX_PKG_VERSION=" "$BUILD_FILE" | cut -d'=' -f2 | tr -d '"')

            if [[ -z "$PKG_VERSION" ]]; then
              echo "⚠️ Skipping $PKG_NAME: TERMUX_PKG_VERSION not found"
              continue
            fi

            SAFE_NAME=$(printf '%s\n' "$PKG_NAME v$PKG_VERSION" | sed 's/[\/&]/\\&/g')

            if ! sed -n '/## \[Unreleased\]/,/^## /p' "$CHANGELOG" | grep -q "$SAFE_NAME"; then
              ADDED="$ADDED- Package \`$PKG_NAME\` v$PKG_VERSION"$'\n'
            fi
          done

          if [[ -z "$ADDED$CHANGED$FIXED" ]]; then
            echo "No new entries detected."
            exit 0
          fi

          if ! grep -q "## \[Unreleased\]" "$CHANGELOG"; then
            echo -e "## [Unreleased]\n" | cat - "$CHANGELOG" > temp && mv temp "$CHANGELOG"
          fi

          insert_section() {
            local section="$1"
            local content="$2"
            if grep -q "### $section" "$CHANGELOG"; then
              sed -i "/### $section/a $(printf '%s' "$content")" "$CHANGELOG"
            else
              sed -i "/## \[Unreleased\]/a ### $section\n$(printf '%s' "$content")" "$CHANGELOG"
            fi
          }

          [[ -n "$ADDED" ]] && insert_section "Added" "$ADDED"
          [[ -n "$CHANGED" ]] && insert_section "Changed" "$CHANGED"
          [[ -n "$FIXED" ]] && insert_section "Fixed" "$FIXED"

      - name: Commit changelog updates (only if changed)
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --cached --quiet || git commit -m "Update changelog: new package versions"
          git diff --cached --quiet || git push origin master
