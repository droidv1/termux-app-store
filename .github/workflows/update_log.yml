name: Auto Update Packages Changelog

on:
  push:
    branches:
      - master
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.termuxappstore }}

      - name: Detect package changes and update changelog
        shell: bash
        run: |
          set -e

          CHANGELOG="CHANGELOG.md"


          if [[ ! -f "$CHANGELOG" ]]; then
            printf "%s\n" \
              "# Changelog" \
              "" \
              "## [Unreleased]" \
              "### Added" \
              "### Updated" \
              "### Fixed" \
              > "$CHANGELOG"
          fi


          git fetch origin master --depth=1
          git diff --name-only HEAD~1 HEAD \
            | grep '^packages/.*/build.sh' > /tmp/changed || true

          [[ -s /tmp/changed ]] || exit 0

          while read -r build; do
            pkg="$(basename "$(dirname "$build")")"
            ver="$(grep '^TERMUX_PKG_VERSION=' "$build" | cut -d= -f2)"

            if grep -q "Package \`${pkg}\`" "$CHANGELOG"; then
              section="Updated"
            else
              section="Added"
            fi

            if ! awk '/## \[Unreleased\]/,/^## \[/' "$CHANGELOG" \
              | grep -q "\`${pkg}\` v${ver}"; then
              sed -i "/### ${section}/a - Package \`${pkg}\` v${ver}" "$CHANGELOG"
            fi
          done < /tmp/changed

      - name: Commit & push changelog
        shell: bash
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"

          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "changelog: update packages [ci skip]"
            git push origin master
          fi
