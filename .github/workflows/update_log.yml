name: Auto Update CHANGELOG

on:
  push:
    branches:
      - master
    paths:
      - 'packages/*/build.sh'

permissions:
  contents: write
  pull-requests: read

jobs:
  update-changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest
    
    # Only run on direct push to master
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          ref: master

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed packages
        id: detect
        shell: bash
        run: |
          set +e  # Don't exit on error
          
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"
          
          echo "Comparing: $BEFORE...$AFTER"

          # Find all changed build.sh files
          CHANGED_FILES=$(git diff --name-only "$BEFORE" "$AFTER" 2>/dev/null | grep 'packages/.*/build.sh' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No build.sh changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed build.sh files:"
          echo "$CHANGED_FILES"

          # Arrays to store entries
          ADDED_ENTRIES=""
          UPDATED_ENTRIES=""
          CHANGED_ENTRIES=""

          # Process each changed build.sh
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            PKG_DIR=$(dirname "$file")
            PKG_NAME=$(basename "$PKG_DIR")
            
            echo "Processing: $PKG_NAME"

            # Check if new package
            if ! git cat-file -e "$BEFORE:$file" 2>/dev/null; then
              echo "  â†’ New package"
              
              VERSION=$(grep -E '^TERMUX_PKG_VERSION=' "$file" 2>/dev/null | head -1 | sed 's/^TERMUX_PKG_VERSION=//' | sed "s/^['\"]//;s/['\"]$//" | tr -d "'" || echo "0.0.0")
              DESC=$(grep -E '^TERMUX_PKG_DESCRIPTION=' "$file" 2>/dev/null | head -1 | sed 's/^TERMUX_PKG_DESCRIPTION=//' | sed "s/^['\"]//;s/['\"]$//" | tr -d "'" || echo "")
              
              if [ -n "$DESC" ]; then
                ADDED_ENTRIES="${ADDED_ENTRIES}- Package \`${PKG_NAME}\` v${VERSION} - ${DESC}\n"
              else
                ADDED_ENTRIES="${ADDED_ENTRIES}- Package \`${PKG_NAME}\` v${VERSION}\n"
              fi
              
            else
              # Check version change
              OLD_VERSION=$(git show "$BEFORE:$file" 2>/dev/null | grep -E '^TERMUX_PKG_VERSION=' | head -1 | sed 's/^TERMUX_PKG_VERSION=//' | sed "s/^['\"]//;s/['\"]$//" | tr -d "'" || echo "")
              NEW_VERSION=$(grep -E '^TERMUX_PKG_VERSION=' "$file" 2>/dev/null | head -1 | sed 's/^TERMUX_PKG_VERSION=//' | sed "s/^['\"]//;s/['\"]$//" | tr -d "'" || echo "")
              
              if [ -n "$OLD_VERSION" ] && [ -n "$NEW_VERSION" ] && [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
                echo "  â†’ Version: $OLD_VERSION â†’ $NEW_VERSION"
                UPDATED_ENTRIES="${UPDATED_ENTRIES}- Package \`${PKG_NAME}\` v${OLD_VERSION} â†’ v${NEW_VERSION}\n"
              else
                # Check metadata changes
                if git diff "$BEFORE" "$AFTER" -- "$file" 2>/dev/null | grep -E '^[+-]TERMUX_PKG_(SRCURL|SHA256|DEPENDS)=' > /dev/null; then
                  echo "  â†’ Metadata changed"
                  CHANGED_ENTRIES="${CHANGED_ENTRIES}- Package \`${PKG_NAME}\` v${NEW_VERSION} - Updated metadata\n"
                fi
              fi
            fi
          done <<< "$CHANGED_FILES"

          # Build changelog entries
          CHANGELOG_ENTRIES=""
          
          [ -n "$ADDED_ENTRIES" ] && CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}### Added\n${ADDED_ENTRIES}\n"
          [ -n "$UPDATED_ENTRIES" ] && CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}### Update\n${UPDATED_ENTRIES}\n"
          [ -n "$CHANGED_ENTRIES" ] && CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}### Changed\n${CHANGED_ENTRIES}\n"

          if [ -z "$CHANGELOG_ENTRIES" ]; then
            echo "No significant changes"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "entries<<EOF"
            echo -e "$CHANGELOG_ENTRIES"
            echo "EOF"
            echo "has_changes=true"
          } >> "$GITHUB_OUTPUT"

          echo "Generated entries:"
          echo -e "$CHANGELOG_ENTRIES"

      - name: Update CHANGELOG.md
        if: steps.detect.outputs.has_changes == 'true'
        shell: bash
        run: |
          set +e  # Don't exit on error
          
          CHANGELOG_FILE="CHANGELOG.md"
          ENTRIES="${{ steps.detect.outputs.entries }}"

          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "âŒ CHANGELOG.md not found!"
            exit 1
          fi

          echo "ðŸ“ Updating CHANGELOG.md..."
          
          # Find [Unreleased] line
          UNRELEASED_LINE=$(grep -n "^## \[Unreleased\]" "$CHANGELOG_FILE" | head -1 | cut -d: -f1)
          
          if [ -z "$UNRELEASED_LINE" ]; then
            echo "âŒ [Unreleased] not found!"
            exit 1
          fi
          
          echo "Found [Unreleased] at line $UNRELEASED_LINE"
          
          # Find first version after [Unreleased]
          VERSION_LINE=$(tail -n +$((UNRELEASED_LINE + 1)) "$CHANGELOG_FILE" | grep -n "^## \[v" | head -1 | cut -d: -f1)
          
          if [ -z "$VERSION_LINE" ]; then
            echo "âŒ No version found after [Unreleased]!"
            exit 1
          fi
          
          VERSION_LINE=$((UNRELEASED_LINE + VERSION_LINE))
          VERSION_HEADER=$(sed -n "${VERSION_LINE}p" "$CHANGELOG_FILE")
          
          echo "Latest version: $VERSION_HEADER (line $VERSION_LINE)"
          
          # Create temp file
          TEMP_FILE=$(mktemp)
          IN_TARGET=0
          INSERTED=0
          LINE_NUM=0
          
          while IFS= read -r line; do
            LINE_NUM=$((LINE_NUM + 1))
            
            # Reached target version
            if [ $LINE_NUM -eq $VERSION_LINE ]; then
              IN_TARGET=1
              echo "$line" >> "$TEMP_FILE"
              continue
            fi
            
            # In target version
            if [ $IN_TARGET -eq 1 ] && [ $INSERTED -eq 0 ]; then
              
              # Check if hit next version
              if [[ "$line" =~ ^##[[:space:]]\[v ]]; then
                IN_TARGET=0
              fi
              
              # Insert entries under correct sections
              if [[ "$line" =~ ^###[[:space:]]Added ]]; then
                echo "$line" >> "$TEMP_FILE"
                if echo "$ENTRIES" | grep -q "^### Added"; then
                  echo "$ENTRIES" | sed -n '/^### Added$/,/^### /p' | sed '$d' | tail -n +2 >> "$TEMP_FILE"
                fi
                continue
                
              elif [[ "$line" =~ ^###[[:space:]]Update ]]; then
                echo "$line" >> "$TEMP_FILE"
                if echo "$ENTRIES" | grep -q "^### Update"; then
                  echo "$ENTRIES" | sed -n '/^### Update$/,/^### /p' | sed '$d' | tail -n +2 >> "$TEMP_FILE"
                fi
                continue
                
              elif [[ "$line" =~ ^###[[:space:]]Changed ]]; then
                echo "$line" >> "$TEMP_FILE"
                if echo "$ENTRIES" | grep -q "^### Changed"; then
                  echo "$ENTRIES" | sed -n '/^### Changed$/,/^### /p' | sed '$d' | tail -n +2 >> "$TEMP_FILE"
                fi
                continue
                
              elif [[ "$line" =~ ^###[[:space:]]Fixed ]] || [[ "$line" =~ ^---$ ]]; then
                INSERTED=1
              fi
            fi
            
            echo "$line" >> "$TEMP_FILE"
            
          done < "$CHANGELOG_FILE"

          mv "$TEMP_FILE" "$CHANGELOG_FILE"
          echo "âœ… CHANGELOG.md updated"

      - name: Commit and push
        if: steps.detect.outputs.has_changes == 'true'
        shell: bash
        run: |
          set +e
          
          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "docs: auto-update CHANGELOG.md [skip ci]"
          
          # Try push
          if git push origin master; then
            echo "âœ… Successfully pushed"
          else
            echo "âš ï¸  Push failed - checking if already up-to-date"
            git pull --rebase origin master
            if git diff origin/master --quiet; then
              echo "âœ… Changes already in remote"
            else
              echo "âŒ Push failed"
              exit 1
            fi
          fi

      - name: Summary
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ“ CHANGELOG Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes added to latest version:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.detect.outputs.entries }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
