name: Auto Update Packages Changelog

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Scan packages and prepare changelog entries
        run: |
          set -euo pipefail

          CHANGELOG="CHANGELOG.md"
          PACKAGES_DIR="packages"

          ADDED=""
          CHANGED=""
          FIXED=""

          echo "Scanning packages for updates..."

          for pkg in "$PACKAGES_DIR"/*; do
            [[ -d "$pkg" ]] || continue
            BUILD_FILE="$pkg/build.sh"
            [[ -f "$BUILD_FILE" ]] || continue

            PKG_NAME=$(basename "$pkg")
            PKG_VERSION=$(grep "^TERMUX_PKG_VERSION=" "$BUILD_FILE" | cut -d'=' -f2 | tr -d '"')

            if [[ -z "$PKG_VERSION" ]]; then
              echo "⚠️ Skipping $PKG_NAME: TERMUX_PKG_VERSION not found"
              continue
            fi

            if ! grep -A 1000 "## \[Unreleased\]" "$CHANGELOG" | grep -q "$PKG_NAME v$PKG_VERSION"; then
              ADDED="$ADDED- Package \`$PKG_NAME\` v$PKG_VERSION"$'\n'
            fi
          done

          if [[ -z "$ADDED$CHANGED$FIXED" ]]; then
            echo "No new entries detected."
            exit 0
          fi

          if ! grep -q "## \[Unreleased\]" "$CHANGELOG"; then
            echo -e "## [Unreleased]\n" | cat - "$CHANGELOG" > temp && mv temp "$CHANGELOG"
          fi

          insert_section_safe() {
            local section="$1"
            local content="$2"

            TMP=$(mktemp)
            awk -v sec="### $section" -v cont="$content" '
            BEGIN { inserted=0 }
            /^## \[Unreleased\]/ {
              print
              if (!inserted) {
                print sec "\n" cont
                inserted=1
              }
              next
            }
            { print }
            ' "$CHANGELOG" > "$TMP"
            mv "$TMP" "$CHANGELOG"
          }

          [[ -n "$ADDED" ]] && insert_section_safe "Added" "$ADDED"
          [[ -n "$CHANGED" ]] && insert_section_safe "Changed" "$CHANGED"
          [[ -n "$FIXED" ]] && insert_section_safe "Fixed" "$FIXED"

      - name: Commit changelog updates (only if changed)
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --cached --quiet || git commit -m "Update changelog: new package versions"
          git diff --cached --quiet || git push origin master
