name: Auto Update Packages Changelog

on:
  push:
    branches:
      - master

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.TERMUXAPPSTORE }}

      - name: Scan packages and update changelog
        run: |
          set -e
          CHANGELOG="CHANGELOG.md"
          PACKAGES_DIR="packages"

          [[ -f "$CHANGELOG" ]] || echo -e "# Changelog\n\n## [Unreleased]\n" > "$CHANGELOG"

          ADDED=""

          for pkg in "$PACKAGES_DIR"/*; do
              [[ -d "$pkg" ]] || continue
              BUILD_FILE="$pkg/build.sh"
              [[ -f "$BUILD_FILE" ]] || continue

              PKG_NAME=$(basename "$pkg")
              PKG_VERSION=$(grep "^TERMUX_PKG_VERSION=" "$BUILD_FILE" | cut -d'=' -f2 | tr -d '"')
              [[ -z "$PKG_VERSION" ]] && continue

              if ! grep -q "$PKG_NAME v$PKG_VERSION" "$CHANGELOG"; then
                  ADDED="${ADDED}- Package \`${PKG_NAME}\` v${PKG_VERSION}"$'\n'
              fi
          done

          [[ -z "$ADDED" ]] && exit 0

          TMP=$(mktemp)
          printf "%s\n" "$ADDED" > "$TMP"

          if ! grep -q "### Added" "$CHANGELOG"; then
              sed -i "/## \[Unreleased\]/a ### Added" "$CHANGELOG"
          fi

          sed -i "/### Added/r $TMP" "$CHANGELOG"
          rm "$TMP"

      - name: Commit and push changelog updates
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+users.noreply.github.com"
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "Update changelog: new package versions [ci skip]"
            git push origin HEAD:master
          else
            echo "No changes to commit."
          fi
