name: Auto Update Packages Changelog

on:
  push:
    branches: [ master ]

jobs:
  changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.TERMUXAPPSTORE }}

      - name: Detect package changes
        run: |
          set -e

          CHANGELOG="CHANGELOG.md"
          [[ -f "$CHANGELOG" ]] || cat <<EOF > "$CHANGELOG"
          # Changelog

          ## [Unreleased]
          ### Added
          ### Updated
          ### Fixed
          EOF

          git diff --name-only HEAD~1 HEAD \
            | grep '^packages/.*/build.sh' > /tmp/changed || true

          [[ -s /tmp/changed ]] || exit 0

          while read -r build; do
            pkg=$(basename "$(dirname "$build")")
            ver=$(grep '^TERMUX_PKG_VERSION=' "$build" | cut -d= -f2 | tr -d '"')

            if grep -q "Package \`${pkg}\`" "$CHANGELOG"; then
              section="Updated"
            else
              section="Added"
            fi

            if ! awk '/## \[Unreleased\]/,/^## \[/' "$CHANGELOG" \
              | grep -q "\`${pkg}\` v${ver}"; then

              sed -i "/### ${section}/a - Package \`${pkg}\` v${ver}" "$CHANGELOG"
            fi
          done < /tmp/changed

      - name: Commit & push
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"

          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "changelog: update packages [ci skip]"
            git push origin master
          fi
